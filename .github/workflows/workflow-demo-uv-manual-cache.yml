name: Manual UV Cache Management

on:
  workflow_dispatch:
    
jobs:
  install_job:
    name: setup-and-install
    runs-on: ubuntu-latest
    env:
      # Configure a constant location for the uv cache
      UV_CACHE_DIR: /tmp/.uv-cache

    steps:
      # setup python and uv
      - name: checkout-repo
        uses: actions/checkout@v6
      
      - name: setup-python
        uses: actions/setup-python@v6
        with:
          python-version-file: "pyproject.toml"
      
      - name: install-uv
        uses: astral-sh/setup-uv@v7
      
      - name: Restore uv cache
        uses: actions/cache@v5
        with:
          path: /tmp/.uv-cache
          key: uv-${{ runner.os }}-${{ hashFiles('**/uv.lock')}}
          restore-keys: |
            uv-${{ runner.os }}-${{ hashFiles('**/uv.lock')}}
            uv-${{ runner.os }}

      - name: install-packages
        run: uv sync --locked --all-extras --dev
      
      - name: run-tests
        run: uv python -m pytest tests
      
      - name: minimize-uv-cache
        run: uv cache prune --ci